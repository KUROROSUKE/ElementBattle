let p1_hand=[],p2_hand=[],p1_point=0,p2_point=0,p1_selected_card=[],p2_selected_card=[],dropped_cards_p1=[],dropped_cards_p2=[],time="game",p1_is_acting=!1;const card_num=8;let WIN_POINT=100,WIN_TURN=5,numTurn=1,turn="p1";const elementToNumber={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Fe:26,Cu:29,Zn:30,I:53},elements=[...Array(6).fill("H"),...[,,,,].fill("O"),...[,,,,].fill("C"),"He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"],element=["H","O","C","He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"];let MineTurn=null,myXP=0;async function initializeMaterials(){if(!await getItem("materials")){let e={};materials.forEach(t=>{e[t.a]=0}),await setItem("materials",e)}await getItem("sumNs")||await setItem("sumNs",0)}async function init_json(){materials=await loadMaterials(compoundsURL="https://kurorosuke.github.io/compounds/obf_extended_min.json")}async function loadMaterials(e){try{let t=await fetch(e),n=await t.json(),a=model?model.outputs[0].shape[1]:108;if(!n.material||!Array.isArray(n.material))return document.getElementById("Attention2").style.display="inline",[];if(document.getElementById("Attention2").style.display="none",console.log(n.material.length),a!=n.material.length){let l=document.getElementById("Attention4");l.innerHTML=`モデルは出力${a}個に対応していますが、compoundsは${n.material.length}個です`,l.style.display="inline"}else document.getElementById("Attention4").style.display="none";return n.material}catch(i){return console.error("Error fetching compounds:",i),document.getElementById("Attention2").style.display="inline",[]}}async function preloadImages(){let e=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,26,29,30,53].map(async e=>{try{let t=`../images/${e}.webp`,n=await fetch(t),a=await n.blob();imageCache[e]=a}catch(l){console.error(`Image loading error: ${e}`,l)}});await Promise.all(e),console.log("✅ 全画像のプリロード完了")}async function preloadBackgroundImages(){let e=window.innerWidth<=730,t=e?"../images/start_screen_mobile.webp":"../images/start_screen_desktop.webp";try{let n=await fetch(t,{cache:"force-cache"}),a=await n.blob(),l=URL.createObjectURL(a),i=new Image;i.src=l,i.style.display="none",document.body.appendChild(i);let r=document.getElementById("startScreen");r.style.backgroundImage=`url('${l}')`,console.log("✅ 背景画像読み込み＆設定完了:",t)}catch(o){console.error("背景画像の読み込みに失敗",t,o)}}document.addEventListener("DOMContentLoaded",async function(){await preloadBackgroundImages(),await preloadImages(),await loadModel(),await init_json(),await initializeMaterials();let e=sessionStorage.getItem("lastDictionary");if(e){let t=materials.find(t=>t.b===e);t&&(switchTab("dictionary"),openMoleculeDetail(t))}await loadQuestsStatus(),peerID=await generatePeerID(),(peer=new Peer(peerID)).on("open",e=>{console.log(e),document.getElementById("my-id").innerText=`自分のPeerID：${e}`,document.getElementById("PeerModal").style.display="none"}),peer.on("connection",e=>{conn=e,null===MineTurn&&(MineTurn="p2"),setupConnection()}),fetchRankingRealtime(),document.getElementById("loading").style.display="none",document.getElementById("startButton").style.display="inline",document.getElementById("OnlineStartButton").style.display="inline",JSZip=(await import("https://cdn.skypack.dev/jszip@3.10.0")).default});const DB_NAME="GameDB",STORE_NAME="GameStore";function openDB(){return new Promise((e,t)=>{let n=indexedDB.open("GameDB",1);n.onerror=e=>t("DB open error"),n.onsuccess=t=>e(t.target.result),n.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(STORE_NAME)||t.createObjectStore(STORE_NAME)}})}async function setItem(e,t){let n=await openDB(),a=n.transaction(STORE_NAME,"readwrite"),l=a.objectStore(STORE_NAME);return l.put(t,e),a.complete}async function getItem(e){let t=await openDB(),n=t.transaction(STORE_NAME,"readonly"),a=n.objectStore(STORE_NAME);return new Promise((t,n)=>{let l=a.get(e);l.onsuccess=()=>t(l.result),l.onerror=()=>n("Get error")})}const firebaseConfig={apiKey:"AIzaSyC0XCxBLbxSg9JVsv8RM89P5N2uLUyonOI",authDomain:"elementbattle3-54850.firebaseapp.com",projectId:"elementbattle3-54850",storageBucket:"elementbattle3-54850.appspot.com",messagingSenderId:"192129204644",appId:"1:192129204644:web:a585308d0e2927648e8131",measurementId:"G-4DX8BD16PN"};firebase.initializeApp(firebaseConfig);const database=firebase.database(),auth=firebase.auth();function getRandomName(){let e=["cat","dog","bird","bear","monkey","fox","deer","penguin"],t=e[Math.floor(Math.random()*e.length)]+Math.floor(1e3*Math.random());return t}function logout(){auth.signOut(),document.getElementById("UserDataModal").style.display="none",document.getElementById("LoginModal").style.display="block"}function handleOutsideClick_LoginModal(e){let t=firebase.auth().currentUser,n;(n=t?document.getElementById("UserDataModal"):document.getElementById("LoginModal")).contains(e.target)||closeLoginModal()}function loginWithGoogle(){let e=new firebase.auth.GoogleAuthProvider;auth.signInWithPopup(e).then(e=>{let t=e.user;console.log("Google login success:",t),document.getElementById("LoginModal").style.display="none",document.getElementById("UserDataModal").style.display="block",startPeer()}).catch(e=>{console.error("Google login failed: ",e),alert("Googleログインに失敗しました")})}function SignUpWithMail(){let e=prompt("メールアドレスを入力してください:"),t=prompt("パスワードを入力してください（6文字以上）:");if(!e||!t){alert("メールアドレスとパスワードを入力してください");return}auth.createUserWithEmailAndPassword(e,t).then(e=>{let t=e.user;console.log("サインアップ成功:",t),alert("サインアップ成功しました"),startPeer()}).catch(e=>{console.error("サインアップ失敗:",e),alert("サインアップに失敗しました: "+e.message)})}function loginWithMail(){let e=prompt("メールアドレスを入力してください:"),t=prompt("パスワードを入力してください:");if(!e||!t){alert("メールアドレスとパスワードを入力してください");return}auth.signInWithEmailAndPassword(e,t).then(e=>{let t=e.user;console.log("ログイン成功:",t),alert("ログイン成功しました"),document.getElementById("LoginModal").style.display="none",document.getElementById("UserDataModal").style.display="block",startPeer()}).catch(e=>{console.error("ログイン失敗:",e),alert("ログインに失敗しました: "+e.message)})}auth.onAuthStateChanged(async e=>{if(!e)return;let t=database.ref(`players/${e.uid}`),n=await t.once("value"),a=n.child("Name").val(),l=n.child("Rate").val();n.exists()?a?n.child("IsSearched").exists()||await t.update({IsSearched:!1}):await t.update({Name:a=getRandomName(),IsSearched:!1}):(await t.set({IsSearched:!1,PeerID:"",Name:a=getRandomName(),Rate:100,myXP:0}),l=100),document.getElementById("UserNameTag").textContent=`名前： ${a}`,document.getElementById("my-rate").textContent=`現在のレート： ${l}`,document.getElementById("rankmatchModal").style.display="block",t.on("value",e=>{let t=e.val(),n=t?t.Rate:0;document.getElementById("my-rate").textContent=`現在のレート： ${n}`});let i=database.ref("players/");i.on("value",e=>{if(e.exists()){let t=e.val(),n=Object.entries(t).map(([e,t])=>({userId:e,name:t.Name||"名無し",rate:t.Rate||0}));n.sort((e,t)=>t.rate-e.rate);let a=n.slice(0,10);showRanking(a)}else console.log("プレイヤーデータが存在しません")},e=>{console.error("データ取得エラー:",e)})}),document.getElementById("user_icon").addEventListener("click",function(){document.getElementById("UserDataMessage").innerHTML="",document.getElementById("name-change").value="";let e=firebase.auth().currentUser,t;(t=e?document.getElementById("UserDataModal"):document.getElementById("LoginModal")).style.display="inline"});let materials=[],imageCache={},peerID,GameType,JSZip;function random_hand(){for(let e=0;e<8;e++)p1_hand.push(drawCard()),p2_hand.push(drawCard())}function resetGame(e=!0){document.getElementById("bottomNav").style.display="none",p1_hand=[],p2_hand=[],dropped_cards_p1=[],dropped_cards_p2=[],p1_selected_card=[],p2_selected_card=[],time="game","P2P"==GameType?"p1"==MineTurn&&(turn=.5>=Math.random()?"p1":"p2",console.log(`random turn :: ${turn}`),changeTurn(turn)):document.getElementById("generate_button").style.display="inline",p1_finish_select=!0,p2_finish_select=!0,document.getElementById("p1_point").innerHTML=`ポイント：${p1_point}`,document.getElementById("p2_point").innerHTML=`ポイント：${p2_point}`,document.getElementById("p2_explain").innerHTML=" ",document.getElementById("predictResult").innerHTML=" ";let t=document.getElementById("p1_explain");t.innerHTML=" ",t.style.color="black",t.style.fontSize="16px",document.getElementById("done_button").style.display="none",document.getElementById("nextButton").style.display="none";let n=document.getElementById("p1_hand"),a=document.getElementById("p2_hand");n.innerHTML="",a.innerHTML="";let l=document.getElementById("dropped_area_p1"),i=document.getElementById("dropped_area_p2");if(l.innerHTML="",i.innerHTML="",e){deck=shuffle(deck=[...elements,...elements]);let r=deck;console.log(r),random_hand()}view_p1_hand(),view_p2_hand(),document.getElementById("hint_button").style.display="inline",turn!==MineTurn&&"CPU"==GameType&&setTimeout(()=>p1_action(),500)}function returnToStartScreen(){document.getElementById("startScreen").style.display="flex",document.getElementById("p1_area").style.display="none",document.getElementById("dropped_area_p1").style.display="none",document.getElementById("dropped_area_p2").style.display="none",document.getElementById("p2_area").style.display="none",document.getElementById("gameRuleButton").style.display="block",document.getElementById("predictResultContainer").style.display="none",document.getElementById("centerLine").style.display="none",document.getElementById("bottomNav").style.display="flex",document.getElementById("nextButton").textContent="次のゲーム",document.getElementById("inGameQuest").style.display="none"}function startGame(e=!0){document.getElementById("startScreen").style.display="none",document.getElementById("p1_area").style.display="block",document.getElementById("dropped_area_p1").style.display="block",document.getElementById("dropped_area_p2").style.display="block",document.getElementById("p2_area").style.display="block",document.getElementById("gameRuleButton").style.display="none",document.getElementById("nextButton").textContent="次のゲーム",resetGame(e)}async function view_p1_hand(){let e=document.getElementById("p1_hand");p1_hand.forEach((t,n)=>{let a=imageCache[0],l=new Image;l.src=URL.createObjectURL(a),l.alt="相手の手札",l.style.padding="5px",l.style.border="1px solid #000",l.classList.add("selected"),l.classList.toggle("selected"),e.appendChild(l)})}async function p1_action(){if("p1"!==turn||p1_is_acting)return;p1_is_acting=!0;let e=materials.filter(e=>e.c>threshold),t=e.sort((e,t)=>{let n=Object.keys(e.d).reduce((t,n)=>t+Math.min(p1_hand.filter(e=>e===n).length,e.d[n]),0);return Object.keys(t.d).reduce((e,n)=>e+Math.min(p1_hand.filter(e=>e===n).length,t.d[n]),0)-n||t.c-e.c}),n=t[0];if(n){let a=!0;for(let l in n.d)if(!p1_hand.includes(l)||p1_hand.filter(e=>e===l).length<n.d[l]){a=!1;break}if(a&&n.c>threshold)time="make",await done("p1");else{let i=p1_hand.filter(e=>!(e in n.d)||p1_hand.filter(t=>t===e).length>n.d[e]);if(i.length>0){let r=i[Math.floor(Math.random()*i.length)];p1_exchange(p1_hand.indexOf(r))}else time="make",done("p1")}}else p1_exchange(Math.floor(Math.random()*p1_hand.length));turn="p2",p1_is_acting=!1}async function p1_exchange(e){console.log("this"),dropped_cards_p1.push(p1_hand[e]);var t=p1_hand[e];if(!p1_hand[e]){console.error("Invalid target element in p1_hand.");return}let n=imageCache[elementToNumber[p1_hand[e]]],a=new Image;a.src=URL.createObjectURL(n),a.style.border="1px solid #000",document.getElementById("dropped_area_p1").appendChild(a);let l=document.querySelectorAll("#p1_hand img")[e];if(!l){console.error("Image element not found in p1_hand.");return}let i=drawCard();p1_hand[e]=i,l.alt=i,l.style.border="1px solid #000",l.classList.remove("selected"),l.classList.add("selected"),l.classList.toggle("selected"),turn="p2",checkRon(t)}async function p1_make(e){let t=await search_materials(arrayToObj(p1_hand));return t&&0!==t.length?(t.sort((e,t)=>t.c-e.c),p1_selected_card=dictToArray(t[0].d),t):[{a:"なし",b:"なし",c:0,d:{},e:[]}]}function selectCardsForMaterial(e,t){let n=[],a=[...e];for(let[l,i]of(a[a.indexOf(p1_selected_card[0])]=null,console.log(a),Object.entries(t))){let r=i;for(let o=0;o<a.length&&r>0;o++)a[o]===l&&(n.push(l),a[o]=null,r--)}return n}async function showDown(){console.log(p1_selected_card);let e=document.getElementById("p1_hand");e.innerHTML="";let t=[...p1_selected_card];p1_hand.forEach((n,a)=>{let l=elementToNumber[n],i=imageCache[l],r=new Image;r.src=URL.createObjectURL(i),r.alt=n,r.style.padding="5px",r.style.border="1px solid #000";let o=t.indexOf(n);-1!==o&&(r.classList.add("selectedP1"),t.splice(o,1)),e.appendChild(r)})}async function view_p2_hand(){let e=document.getElementById("p2_hand");p2_hand.forEach((t,n)=>{let a=imageCache[elementToNumber[t]],l=new Image;l.src=URL.createObjectURL(a),l.alt=t,l.style.padding="5px",l.style.border="1px solid #000",l.classList.add("selected"),l.classList.toggle("selected"),l.classList.add("p2_card"),l.addEventListener("click",function(){let e=document.getElementById("ron_button");if(e.style.display="none","make"==time&&(this.classList.toggle("selected"),this.classList.contains("selected")?p2_selected_card.push(this.alt):p2_selected_card.splice(p2_selected_card.indexOf(this.alt),1)),turn==MineTurn&&"game"==time){dropped_cards_p2.push(this.alt);let t=imageCache[elementToNumber[this.alt]],a=new Image;a.src=URL.createObjectURL(t),a.alt=this.alt,a.style.border="1px solid #000",document.getElementById("dropped_area_p2").appendChild(a),this.classList.remove("selected"),this.classList.add("selected"),this.classList.toggle("selected"),this.classList.add("p2_card");let l=drawCard(),i=imageCache[elementToNumber[l]];if(this.src=URL.createObjectURL(i),this.alt=l,this.style.padding="5px",this.style.border="1px solid #000",p2_hand[n]=l,"CPU"==GameType){turn="p1","none"!=document.getElementById("hintContainer").style.display&&document.getElementById("hint_button").click();let r=a.alt;setTimeout(()=>{checkRon(r)},500)}else changeTurn(turn="p2"==turn?"p1":"p2"),shareAction(action="exchange",otherData=a.alt)}}),e.appendChild(l)})}async function p2_make(e="p2"){time="make",document.getElementById("generate_button").style.display="none",document.getElementById("hintContainer").style.display="none",document.getElementById("hint_button").style.display="none";let t=document.getElementById("done_button");return t.style.display="inline",t._handler&&t.removeEventListener("click",t._handler),new Promise(n=>{t._handler=async()=>{t.style.display="none",p2_make_material=await search(arrayToObj(p2_selected_card)),"P2P"===GameType&&finishSelect(e),n(p2_make_material)},t.addEventListener("click",t._handler,{once:!0})})}async function checkRon(e){if("CPU"===GameType){if("p2"===turn){let t=await search_materials(arrayToObj([...p2_hand,e])),n=t.filter(t=>t.d[e]);if(n.length>0){let a=document.getElementById("ron_button");a.style.display="inline",a.replaceWith(a.cloneNode(!0));let l=document.getElementById("ron_button");l.addEventListener("click",function(){l.style.display="none";let t=document.querySelectorAll("#dropped_area_p1 img"),n=t[t.length-1];n.classList.add("selected"),p2_selected_card=[e],time="make",done("p2",p2_ron=!0)})}}else if("p1"===turn){console.log("P1 ron check");let i=await search_materials(arrayToObj([...p1_hand,e])),r=[];if(i.length>0){let o=i.reduce((e,t)=>t.c>e.c?t:e);console.log(o),o.c>=1.2*threshold&&e in o.d&&(r=[o])}if(r.length>0){console.log("P1 ron button"),time="make";let d=document.getElementById("dropped_area_p2").children,s=d[d.length-1];s.classList.add("selectedP1"),done("p1",r,e,p1_ron=!0)}else p1_action()}}else{console.log("this");let c=await search_materials(arrayToObj([...p2_hand,e])),p=c.filter(t=>t.d[e]);if(p.length>0){let u=document.getElementById("ron_button");u.style.display="inline",u.replaceWith(u.cloneNode(!0));let m=document.getElementById("ron_button");m.addEventListener("click",function(){m.style.display="none",p2_selected_card=[e],p2_make();let t=document.getElementById("dropped_area_p1").children,n=t[t.length-1];n.style.border="2px solid red",shareAction(action="generate",otherData=MineTurn)})}}}document.getElementById("startButton").addEventListener("click",function(){document.getElementById("startScreen").style.display="none",document.getElementById("p1_area").style.display="block",document.getElementById("dropped_area_p1").style.display="block",document.getElementById("dropped_area_p2").style.display="block",document.getElementById("p2_area").style.display="block",document.getElementById("gameRuleButton").style.display="none",document.getElementById("predictResultContainer").style.display="none",document.getElementById("centerLine").style.display="block",MineTurn="p2",GameType="CPU",inGameQuest.style.display="block",changeQuest(),resetGame()}),document.getElementById("generate_button").addEventListener("click",async function(){turn==MineTurn&&(document.getElementById("hintContainer").style.display="none",document.getElementById("hint_button").style.display="none",time="make",document.getElementById("ron_button").style.display="none","CPU"==GameType?done("p2"):(shareAction(action="generate",otherData=MineTurn),await p2_make()))});let base_point_bonus=!1;async function get_dora(){return element[Math.round(23*Math.random())]}async function done(e,t,n,a=!1,l=!1){console.log(t),document.getElementById("ron_button").style.display="none",document.getElementById("hint_button").style.display="none",document.getElementById("hintContainer").style.display="none";let i=await p2_make(),r=await runModel("p1"==e?0:1,i.f),o=a?t:await p1_make(r);console.log(o),p1_selected_card.push(...dictToArray(o[0].d)),p1_selected_card.splice(p1_selected_card.indexOf(n),1);let d=await get_dora();console.log(`ドラ: ${d}`);let s=i.c,c=o[0].c;Boolean(i.e.includes(o[0].b))?s*=1.5+Math.random()/2:Boolean(o[0].e.includes(i.b))&&(c*=1.5+Math.random()/2),Boolean(Object.keys(i.d).includes(d))?s*=1.5:Boolean(Object.keys(o[0].d).includes(d))&&(c*=1.5),(a||l)&&("p2"==e?s/=1.2:c/=1.2),"p2"==e?c/=1.5:s/=1.5,s=Math.round(s),base_point_bonus&&(s+=s),p1_point+=await (c=Math.round(c)),p2_point+=await s,document.getElementById("p2_point").innerHTML+=`+${s}`,document.getElementById("p1_point").innerHTML+=`+${c}`,document.getElementById("p2_explain").innerHTML=`生成物質：${i.a}, 組成式：${i.b}`,document.getElementById("p1_explain").innerHTML=`生成物質：${o[0].a}, 組成式：${o[0].b}`,"p2"===e&&await checkQuest(i,s),IsTraining&&(await addTrainingData(p2_hand,i.f,"p1"==e?0:1),await trainModel(),await incrementMaterialCount(i.a));let p=await win_check(),u=document.getElementById("p1_explain");"p1"==p?(u.innerHTML="YOU LOSE",u.style.color="blue",u.style.fontSize="5vh"):"p2"==p&&(u.innerHTML="YOU WIN!",u.style.color="red",u.style.fontSize="5vh"),document.getElementById("done_button").style.display="none";let m=document.getElementById("nextButton");m.style.display="inline",showDown(),p?(console.log("ゲーム終了"),m.textContent="ラウンド終了",m.addEventListener("click",function(){p1_point=0,p2_point=0,numTurn=1,resetGame(),returnToStartScreen(),m.style.display="none";let e=m.cloneNode(!0);m.parentNode.replaceChild(e,m)})):(console.log("次のゲーム"),numTurn+=1,m.textContent="次のゲーム",m.addEventListener("click",function(){document.getElementById("predictResultContainer").style.display="none",resetGame(),m.style.display="none";let e=m.cloneNode(!0);m.parentNode.replaceChild(e,m)}))}async function win_check(){return Math.abs(p1_point-p2_point)>=WIN_POINT?p1_point>p2_point?"p1":"p2":numTurn>=WIN_TURN?p1_point>p2_point?"p1":"p2":null}function convertToVector2(e,t){let n=Array(t.length).fill(0);return e.forEach(e=>{let a=t.indexOf(e);-1!==a&&n[a]++}),n}function convertToVector(e,t){return t.map(t=>e[t]||0)}function cosineSimilarity(e,t){let n=0,a=0,l=0;for(let i=0;i<e.length;i++)n+=e[i]*t[i],a+=e[i]**2,l+=t[i]**2;return a=Math.sqrt(a),l=Math.sqrt(l),a&&l?n/(a*l):0}function pseudoCosVec(e,t){let n=convertToVector(materials[e].d,element),a=convertToVector(materials[t].d,element);console.log(n,a);let l=cosineSimilarity(n,a);return l}function findClosestMaterials(e){let t=convertToVector2(e,element);return materials.map((e,n)=>{let a=Array(element.length).fill(0);for(let[l,i]of Object.entries(e.d)){let r=element.indexOf(l);-1!==r&&(a[r]=i)}return{index:n,similarity:cosineSimilarity(t,a)}}).sort((e,t)=>t.similarity-e.similarity).slice(0,3)}function findClosestMaterial(e){let t=null,n=0;return materials.forEach((a,l)=>{let i=cosineSimilarity(e,Object.values(a.d));i>n&&(n=i,t={index:l,similarity:i})}),t}async function findMostPointMaterial(){let e=await search_materials(arrayToObj(p2_hand));if(0===e.length)console.log("p2_hand 内で作成可能な物質はありません。");else{let t=e.reduce((e,t)=>t.c>e.c?t:e,e[0]);console.log(`p2_hand 内で最もポイントが高い物質: ${t.a} (ポイント: ${t.c})`)}}function arrayToObj(e){let t={};return e.forEach(e=>{t[e]?t[e]++:t[e]=1}),t}function dictToArray(e){let t=[];for(let[n,a]of Object.entries(e))for(let l=0;l<a;l++)t.push(n);return t}function shuffle(e){let t=e.length;for(;0!=t;){let n=Math.floor(Math.random()*t);t--,[e[t],e[n]]=[e[n],e[t]]}return e}async function no_draw_card(){shareAction(action="generate",otherData="no-draw-card"),await p2_make(who="no-draw")}function drawCard(){if(deck.length>0)return deck.pop();"CPU"==GameType?done("no-draw"):no_draw_card()}function removeCards(e,t){let n=new Map;for(let a of t)n.set(a,(n.get(a)||0)+1);return e.filter(e=>!(n.has(e)&&n.get(e)>0)||(n.set(e,n.get(e)-1),!1))}async function CanCreateMaterial(e){if(!e)return console.error("❌ Error: Material is undefined!"),!0;let t=e.d,n={},a=[...p1_hand,...dropped_cards_p1,...dropped_cards_p2],l=[...elements,...elements];if((l=await removeCards(l,a)).forEach(e=>{n[e]=(n[e]||0)+1}),0==e.c)return console.log("Material has c == 0, returning true."),!0;for(let i in t)if(!n[i]||n[i]<t[i])return console.log(`Missing element: ${i}, returning true.`),!0;return!1}async function search_materials(e){return materials.filter(t=>{for(let n in t.d)if(!e[n]||t.d[n]>e[n])return!1;return!0})}async function search(e){return materials.find(t=>{for(let n in e)if(!t.d[n]||t.d[n]!==e[n])return!1;for(let a in t.d)if(!e[a])return!1;return!0})||materials[0]}document.getElementById("hint_button").addEventListener("click",function(){let e=findClosestMaterials(p2_hand),t=document.getElementById("hintTable").getElementsByTagName("tbody")[0];if(t.innerHTML="",0===e.length){let n=t.insertRow().insertCell(0);n.colSpan=3,n.innerHTML="近い物質が見つかりません",n.style.textAlign="center";return}e.forEach(e=>{let n=materials[e.index],a=t.insertRow(),l=a.insertCell(0),i=a.insertCell(1),r=a.insertCell(2);l.innerHTML=n.a,i.innerHTML=n.b,r.innerHTML=n.c}),document.getElementById("hintContainer").style.display="inline"});let xs=[],ys=[],isTraining=!1,model,modelName,outputNum;const countTemplate=Object.fromEntries(Object.values(elementToNumber).map(e=>[e,0]));function extractModelName(e){let t=e.match(/\/([^\/]+)$/);return t?t[1]:null}async function loadModel(e=null,t=null){try{if(null==e){let n=await tf.io.listModels();modelName="standardModel2",n["indexeddb://standardModel2"]?(model=await tf.loadLayersModel("indexeddb://standardModel2"),console.log("ローカルの学習済みモデルをロードしました")):(model=await tf.loadLayersModel("https://kurorosuke.github.io/AI_models/model3/model.json"),console.log("サーバーからモデルをロードしました"),await saveModel())}else{let a=await tf.io.listModels();a[`indexeddb://${modelName=null==t?extractModelName(e):t}`]?(model=await tf.loadLayersModel(`indexeddb://${modelName}`),console.log("ローカルの学習済みモデルをロードしました")):(console.log(`${e}/model.json`),model=await tf.loadLayersModel(`${e}/model.json`),console.log("サーバーからモデルをロードしました")),await saveModel()}if(addOptions(),(outputNum=model.outputs[0].shape[1])!=materials.length){let l=document.getElementById("Attention4");l.innerHTML=`モデルは出力${outputNum}個に対応していますが、compoundsは${materials.length}個です`,l.style.display="inline"}else document.getElementById("Attention4").style.display="none";document.getElementById("Attention").style.display="none"}catch(i){console.error("モデルのロードに失敗しました",i),document.getElementById("Attention").style.display="block"}}function oneHotEncode(e,t){let n=Array(t).fill(0);return n[e]=1,n}async function convertToCount(e){let t={...countTemplate};return e.forEach(e=>{let n=elementToNumber[e];void 0!==n&&(t[n]+=1)}),Object.values(t)}async function addTrainingData(e,t,n){if(!model){console.log("モデルがロードされていません");return}console.log(`playerData: ${e}`);var a=await convertToCount(e),l=a.reduce(function(e,t){return e+t},0);a.push(n),a.push(2*l+Number(!n)+1),console.log(`InputData: ${a}`);let i=tf.tensor2d([a],[1,26]),r=tf.tensor2d([oneHotEncode(t,model.outputShape[1])],[1,model.outputShape[1]]);xs.push(i),ys.push(r),console.log("データを追加しました: クラス",t)}async function trainModel(){if(!model||0===xs.length){console.log("学習データが不足しています");return}if(isTraining)return;if(isTraining=!0,model.compile({optimizer:tf.train.adam(.002),loss:"categoricalCrossentropy",metrics:["accuracy"]}),!model.outputShape||model.outputShape.length<2){console.error("モデルの outputShape が不正です:",model.outputShape);return}let e=tf.concat(xs),t=tf.concat(ys);await model.fit(e,t,{epochs:2,batchSize:32,callbacks:{onEpochEnd(e,t){console.log(`Epoch ${e+1}: Loss = ${t.loss.toFixed(4)}, Accuracy = ${t.acc.toFixed(4)}`)}}}),console.log("手札に最も近い物質のデータを追加学習...");let n=[],a=[],l=model.outputShape[1]||(materials?materials.length:10);if(!l||isNaN(l)){console.error("numClasses が不正です:",l),isTraining=!1;return}if(xs.forEach((e,t)=>{let i=findClosestMaterials(p2_hand)[0];if(console.log(i),!i){console.warn(`手札 ${t} に対応する近い物質が見つかりません。スキップします。`);return}let r=i.index;console.log(r),console.log(`学習対象: 手札 ${t} → 近い物質: materials[${r}]`);let o=oneHotEncode(r,l);a.push(tf.tensor2d([o],[1,l])),n.push(e)}),0===n.length||0===a.length){console.warn("追加学習用のデータが不足しているため、スキップします。"),isTraining=!1;return}let i=tf.concat(n),r=tf.concat(a);model.compile({optimizer:tf.train.adam(.001),loss:"categoricalCrossentropy",metrics:["accuracy"]}),await model.fit(i,r,{epochs:1,batchSize:32,callbacks:{onEpochEnd(e,t){console.log(`Epoch ${e+1}: Loss = ${t.loss.toFixed(4)}, Accuracy = ${t.acc.toFixed(4)}`)}}}),console.log("モデルの追加学習が完了しました"),e.dispose(),t.dispose(),i.dispose(),r.dispose(),xs=[],ys=[],isTraining=!1,await saveModel()}async function runModel(e,t){if(!model){console.log("モデルがロードされていません");return}var n=await convertToCount(dropped_cards_p2),a=n.reduce(function(e,t){return e+t},0);n.push(e),n.push(2*a+Number(!e)+1),n=tf.tensor2d([n],[1,26]);let l=model.predict(n),i=await l.data(),r,o=await calculateWeightedProbabilities(calculatePseudoProbabilities(getUsedMaterials()),i),d=Object.entries(o).sort((e,t)=>t[1]-e[1]),s=d.slice(0,3),c=d.findIndex(([e])=>e==t)+1;s.push([t,o[t]]);let p=document.getElementById("predictTable").getElementsByTagName("tbody")[0];p.innerHTML="";let u=["1位","2位","3位",`${c}位`];s.forEach(([e,t],n)=>{if(null!=materials[e]){let a=p.insertRow(),l=a.insertCell(0),i=a.insertCell(1),r=a.insertCell(2);l.innerHTML=u[n],i.innerHTML=materials[e].a,r.innerHTML=(100*t).toFixed(2)+"%"}}),document.getElementById("predictResultContainer").style.display="inline";var m=Math.max(...Object.values(o)),y=Object.keys(o).find(e=>o[e]===m);console.log(`予測した化合物のキー：${y}`);try{for(;await CanCreateMaterial(materials[y]);){if(delete o[y],0===Object.keys(o).length){console.log("作成できる候補がありません");return}var m=Math.max(...Object.values(o)),y=Object.keys(o).find(e=>o[e]===m)}}catch{console.log(materials[y]),null==materials[y]&&console.log("モデルと化合物のバージョンが異なります")}y<=materials.length&&console.log(`推論結果: クラス ${y}, 信頼度: ${m}`)}async function saveModel(){if(!model){console.log("モデルがロードされていません");return}try{console.log(`indexeddb://${modelName}`),await model.save(`indexeddb://${modelName}`),console.log("学習済みモデルを IndexedDB に保存しました")}catch(e){console.error("モデルの保存に失敗しました",e)}}async function warmUpModel(){let e=tf.tensor2d([Array(26).fill(0)],[1,26]);model.predict(e),console.log("✅ モデルのウォームアップ完了")}async function getUsedMaterials(){let e=await getItem("materials");return e&&"{}"!==e?Object.fromEntries(Object.entries(e).filter(([e,t])=>t>0)):(console.log("No valid materials data found."),{})}function calculatePseudoProbabilities(e){let t=Object.values(e).reduce((e,t)=>e+t,0);if(0===t)return{};let n={};for(let a in e)n[a]=e[a]/t;return n}async function calculateWeightedProbabilities(e,t){let n={};for(let a in t)e.hasOwnProperty(a)?(sumNs=await getItem("sumNs"),n[a]=(e[a]*sumNs/(sumNs+10)+t[a])/2):n[a]=t[a];return n}async function incrementMaterialCount(e){let t=await getItem("materials");t[e]=(materials[e]||0)+1,await setItem("materials",t),await setItem("sumNs",await getItem("sumNs")+1)}function showRules(){document.getElementById("rulesModal").style.display="block"}function closeRules(){document.getElementById("rulesModal").style.display="none"}function handleOutsideClick(e){let t=document.getElementById("rulesModal");e.target===t&&closeRules()}function closePeerModal(){document.getElementById("PeerModal").style.display="none",window.removeEventListener("click",handleOutsideClick_PeerModal),window.removeEventListener("touchstart",handleOutsideClick_PeerModal)}function handleOutsideClick_PeerModal(e){let t=document.getElementById("PeerModal");t.contains(e.target)||closePeerModal()}document.getElementById("closeRulesButton").addEventListener("click",closeRules),window.addEventListener("click",handleOutsideClick),window.addEventListener("touchstart",handleOutsideClick),document.getElementById("OnlineStartButton").addEventListener("click",function(){let e=document.getElementById("PeerModal");e.style.display="inline",setTimeout(()=>{window.addEventListener("click",handleOutsideClick_PeerModal),window.addEventListener("touchstart",handleOutsideClick_PeerModal)},100)});let is_ok_p1=!1,is_ok_p2=!1,p1_finish_select=!0,p2_finish_select=!0,p1_make_material={},p2_make_material,peer,conn;async function finish_done_select(e,t,n,a=!1){if("P2P"===GameType&&"p1"!==MineTurn)return;if(!e||!t){console.error("⚠️ material data is missing — finish_done_select aborted.");return}let l=await get_dora();console.log(`ドラ: ${l}`),console.log(e),console.log(t);let i=t.c,r=e.c;t.e?.includes?.(e.b)?i*=1.5+Math.random()/2:e.e?.includes?.(t.b)&&(r*=1.5+Math.random()/2),Object.keys(t.d).includes(l)?i*=1.5:Object.keys(e.d).includes(l)&&(r*=1.5),a&&("p2"===n?i/=1.2:r/=1.2),"p2"===n?r/=1.5:i/=1.5,i=Math.round(i),p1_point+=r=Math.round(r),p2_point+=i,document.getElementById("p1_point").innerHTML+=`+${r}`,document.getElementById("p2_point").innerHTML+=`+${i}`,document.getElementById("p2_explain").innerHTML=`生成物質：${t.a}, 組成式：${t.b}`,document.getElementById("p1_explain").innerHTML=`生成物質：${e.a}, 組成式：${e.b}`,sharePoints(),winnerAndChangeButton()}function waitUntilBothTrue(e,t,n=100){return new Promise(a=>{let l=setInterval(()=>{e()&&t()&&(clearInterval(l),a())},n)})}async function winnerAndChangeButton(){let e=await win_check();document.getElementById("done_button").style.display="none";let t=document.getElementById("nextButton");if(t.style.display="inline",!e){console.log("次のゲーム"),t.textContent="次のゲーム",t.addEventListener("click",async function(){is_ok_p2=!0,nextIsOK(),t.style.display="none",await waitUntilBothTrue(()=>is_ok_p1,()=>is_ok_p2),is_ok_p1=!1,is_ok_p2=!1,numTurn+=1,resetGame();let e=t.cloneNode(!0);t.parentNode.replaceChild(e,t)});return}console.log("ラウンド終了"),t.textContent="ラウンド終了";let n=String(e).trim(),a=document.getElementById("p1_explain");"p2"!==n?(a.innerHTML="YOU LOSE",a.style.color="blue",a.style.fontSize="5vh"):(a.innerHTML="YOU WIN!",a.style.color="red",a.style.fontSize="5vh"),t.addEventListener("click",async function(){p1_point=0,p2_point=0,numTurn=1;let e=firebase.auth().currentUser;if(IsRankMatch&&e&&"p1"===MineTurn){let a=e.uid,l=opponentUid;await updateRating("p2"===n?a:l,"p2"===n?l:a)}IsRankMatch=!1,conn.close(),resetGame(),returnToStartScreen(),t.style.display="none";let i=t.cloneNode(!0);t.parentNode.replaceChild(i,t)})}async function generatePeerID(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=e.charAt(Math.floor(Math.random()*e.length)),n=e.charAt(Math.floor(Math.random()*e.length)),a="",l=e+"-_";for(let i=0;i<4;i++)a+=l.charAt(Math.floor(Math.random()*l.length));return"EB3_"+t+a+n}function connectToPeer(){null===MineTurn&&(MineTurn="p1");let e=document.getElementById("remote-id").value;document.getElementById("PeerModal").style.display="none",conn=peer.connect(e),setupConnection()}function setupConnection(){if(!conn||conn.__eb3HandlersInstalled)return;conn.__eb3HandlersInstalled=!0;let e=()=>{!conn.__eb3OpenInited&&conn.open&&(conn.__eb3OpenInited=!0,GameType="P2P","p1"===MineTurn&&(conn.send({type:"role",value:"p2"}),startGame(),shareVariable(),changeTurn("p1")),document.getElementById("PeerModal").style.display="none")};conn.on("open",e),conn.open&&setTimeout(e,0),conn.on("data",e=>{if(console.log("\uD83D\uDCE9",e),"role"===e.type){MineTurn=e.value,turn="p1";return}if("variables"===e.type){e.compounds_url&&(compoundsURL=e.compounds_url,(async()=>{materials=await loadMaterials(compoundsURL)})()),startGame(CreateHandAndDeck=!0),p2_hand=e.p1_hand,deck=e.deck,WIN_POINT=e.win_point,WIN_TURN=e.win_turn,document.getElementById("p1_hand").innerHTML="",document.getElementById("p2_hand").innerHTML="",view_p1_hand(),view_p2_hand();return}if("turn"===e.type){(turn=e.value)===MineTurn?document.getElementById("generate_button").style.display="inline":document.getElementById("generate_button").style.display="none";return}if("action"===e.type){if("exchange"===e.action){deck=e.deck,dropped_cards_p1.push(e.otherData);let t=imageCache[elementToNumber[e.otherData]],n=new Image;n.src=URL.createObjectURL(t),n.alt=e.otherData,n.style.border="1px solid #000",document.getElementById("dropped_area_p1").appendChild(n),checkRon(e.otherData)}else"generate"===e.action&&p2_make(e.otherData);return}if("selected"===e.type){if(p1_finish_select=!1,p1_make_material=e.otherData,!p2_finish_select){console.log(p2_make_material);let a="no-draw"==e.who?"no-draw":"p2";finish_done_select(p1_make_material,p2_make_material,a)}return}if("pointsData"===e.type){if("p1"===MineTurn)return;let l=document.getElementById("p1_point"),i=document.getElementById("p2_point"),r=e.p1_point-p1_point,o=e.p2_point-p2_point;!Number.isFinite(r)||Math.abs(r)>1e5?l.innerHTML=`ポイント：${e.p1_point}`:l.innerHTML+=`+${r}`,!Number.isFinite(o)||Math.abs(o)>1e5?i.innerHTML=`ポイント：${e.p2_point}`:i.innerHTML+=`+${o}`,document.getElementById("p1_explain").innerHTML=e.p1_explain,document.getElementById("p2_explain").innerHTML=e.p2_explain,p1_point=e.p1_point,p2_point=e.p2_point,winnerAndChangeButton();return}if("nextIsOK"===e.type){is_ok_p1=!0;return}void 0!==e.p1_hand&&(p1_hand=e.p1_hand),void 0!==e.deck&&(deck=e.deck)}),conn.on("close",()=>{console.log(document.getElementById("nextButton").textContent),"次のゲーム"===document.getElementById("nextButton").textContent&&(console.log("次のゲーム"==document.getElementById("nextButton").textContent),console.log("次のゲーム"===document.getElementById("nextButton").textContent),alert("ゲーム終了"),returnToStartScreen())})}function shareVariable(){conn&&conn.open?(console.log(deck),conn.send({type:"variables",p1_hand:p1_hand,deck:deck,PartnerTurn:MineTurn,win_point:WIN_POINT,win_turn:WIN_TURN,compounds_url:compoundsURL})):console.log("⚠️ 接続が開かれていません！")}function shareAction(e,t){conn&&conn.open?conn.send({type:"action",action:e,otherData:t,deck:deck}):console.error("⚠️ 接続が開かれていません！ アクションを送信できません。")}function changeTurn(e){conn&&conn.open&&(turn=e,conn.send({type:"turn",value:e}),turn===MineTurn?document.getElementById("generate_button").style.display="inline":document.getElementById("generate_button").style.display="none")}async function finishSelect(e){conn&&conn.open&&(p2_finish_select=!1,console.log("complete send selected to other player"),conn.send({type:"selected",value:MineTurn,who:e,otherData:p2_make_material}))}async function sharePoints(){if(("P2P"!==GameType||"p1"===MineTurn)&&conn&&conn.open){let e=document.getElementById("p2_explain").textContent,t=document.getElementById("p1_explain").textContent;conn.send({type:"pointsData",p1_point:p2_point,p1_explain:e,p2_point:p1_point,p2_explain:t})}}async function nextIsOK(){conn&&conn.open&&conn.send({type:"nextIsOK",content:!0})}function startPeer(){let e=firebase.auth().currentUser,t=database.ref("players/"+e.uid);t.update({PeerID:peerID}),document.getElementById("winSettingsModal").style.display="none"}async function getOpponentPeerID(e){try{let t=await database.ref("players").orderByChild("IsSerched").equalTo(!0).limitToFirst(1).once("value");if(!t.exists())return null;let n=Object.keys(t.val())[0];if(n===e)return null;let a=await database.ref(`players/${n}/PeerID`).once("value");return a.val()??null}catch(l){return console.error("getOpponentPeerID error:",l),null}}let opponentUid,IsRankMatch=!1,myRankQueueRef=null,isSearchingRank=!1,rankQueueListener=null;async function cancelRankMatch(){isSearchingRank=!1;let e=firebase.auth().currentUser;if(!e)return;let t=database.ref("rankQueue");rankQueueListener&&(t.off("value",rankQueueListener),rankQueueListener=null);try{await t.child(e.uid).remove()}catch(n){console.warn("cancelRankMatch: remove failed",n)}finally{myRankQueueRef=null;let a=document.getElementById("RankMatchButton");a.innerHTML="対戦",a.disabled=!1,a.setAttribute("aria-disabled","false")}}async function RankMatch(){let e=firebase.auth().currentUser;if(!e){alert("Google またはメールでログインしてください");return}if(isSearchingRank){await cancelRankMatch();return}let t=database.ref("rankQueue");isSearchingRank=!0;let n=document.getElementById("RankMatchButton");n.innerHTML="キャンセル",n.disabled=!1,n.setAttribute("aria-disabled","false"),await (myRankQueueRef=t.child(e.uid)).set({uid:e.uid,peerID:peer.id,ts:firebase.database.ServerValue.TIMESTAMP});try{myRankQueueRef.onDisconnect().remove()}catch(a){console.warn("onDisconnect().remove() failed",a)}rankQueueListener=async a=>{if(!isSearchingRank)return;let l=a.val();if(!l)return;let i=Object.entries(l).map(([e,t])=>[e,t]).sort(([,e],[,t])=>(e.ts??0)-(t.ts??0));if(i.length<2)return;let[r,o]=i[0],[d,s]=i[1],c,p=!1;if(s.uid===e.uid){c=o,p=!0,opponentUid=o.uid;let u=await firebase.database().ref(`players/${opponentUid}`).once("value"),{Name:m,Rate:y}=u.val();document.getElementById("opponentName").innerHTML=`${m}`,document.getElementById("opponentRate").innerHTML=`${y}`,await t.child(r).remove(),await t.child(d).remove()}else{if(o.uid!==e.uid)return;c=s,p=!1,opponentUid=s.uid;let g=await firebase.database().ref(`players/${opponentUid}`).once("value"),{Name:h,Rate:f}=g.val();document.getElementById("opponentName").innerHTML=`${h}`,document.getElementById("opponentRate").innerHTML=`${f}`}t.off("value",rankQueueListener),rankQueueListener=null,myRankQueueRef=null,isSearchingRank=!1,IsRankMatch=!0,handShake(c,p),n.innerHTML="対戦",n.disabled=!1,n.setAttribute("aria-disabled","false")},t.on("value",rankQueueListener)}function handShake(e,t){if(t){MineTurn="p1",turn="p1";let n=e.peerID;conn=peer.connect(n,{reliable:!0}),setupConnection()}else MineTurn="p2"}async function updateRating(e,t){console.log(t);let n=database.ref("players"),[a,l]=await Promise.all([n.child(e).once("value"),n.child(t).once("value")]),i=a.child("Rate").val()||100,r=l.child("Rate").val()||100,o=1/(1+Math.pow(10,(r-i)/400)),d=Math.round(i+32*(1-o)),s=Math.round(r+32*(0-(1-o))),c={};c[`${e}/Rate`]=d,c[`${t}/Rate`]=s,await n.update(c),console.log(`レート更新完了: 勝者(${d}), 敗者(${s})`)}let selectingModel,IsTraining,compoundsURL;async function saveWinSettings(){let e=parseInt(document.getElementById("winPointInput").value,10),t=parseInt(document.getElementById("winTurnInput").value,10),n=parseFloat(document.getElementById("threshold").value),a=document.getElementById("IsTraining").value,l=document.getElementById("compoundsSelection").value;if(compoundsURL="url"===l?document.getElementById("compoundsURL").value:`https://kurorosuke.github.io/compounds/obf_${l}_min.json`,isNaN(e)){alert("コールドスコア は 1 以上 999 以下の数値を入力してください。");return}if(e<1){alert("コールドスコア は 1 以上の数値を入力してください。");return}if(e>999){if(20100524==e){alert("開発モード！ポイント２倍！"),base_point_bonus=!0;return}alert("コールドスコア の最大値は 999 です。");return}if(isNaN(t)||t<1){alert("ターン数 は 1 以上の数値を入力してください。");return}if(isNaN(n)||n<0){alert("相手しきい値 は 0以上の値にしてください。");return}threshold=n,WIN_POINT=e,WIN_TURN=t,IsTraining=a,materials=await loadMaterials(compoundsURL)}function showInputTag(){"url"==document.getElementById("compoundsSelection").value?document.getElementById("compoundsUrlRow").style.display="flex":document.getElementById("compoundsUrlRow").style.display="none"}let removeTarget=[];async function getModelsDate(e){try{let t=await tf.io.listModels(),n=t[`indexeddb://${e}`];if(!n)return"N/A";return new Date(n.dateSaved).toLocaleString()}catch(a){return console.error(`Error fetching date for model ${e}:`,a),"N/A"}}async function getModelNames(){try{let e=await tf.io.listModels(),t=Object.keys(e).map(e=>e.replace("indexeddb://",""));return t}catch(n){return console.error("モデル名の取得に失敗しました",n),[]}}function showModelDetail(){addOptions(),document.getElementById("modelModals").style.display="inline",document.getElementById("buttonModal").style.display="inline",document.getElementById("overlay").style.display="inline"}async function addLoadingButton(){let e=document.getElementById("modelModals"),t=document.createElement("input");t.type="file",t.id="modelFileInput",t.style.display="none",t.accept=".zip";let n=document.createElement("label");n.setAttribute("for","modelFileInput"),n.innerText="モデルを読み込む",n.style.display="inline-block",n.style.padding="10px 0px",n.style.backgroundColor="#eee",n.style.border="1px solid #ccc",n.style.borderRadius="6px",n.style.cursor="pointer",n.style.textAlign="center",n.style.margin="0 0 20px 0",n.id="FileLoadLabel",t.addEventListener("change",async e=>{let n=Array.from(e.target.files),a,l;try{let i=n[0];if(!i||!i.name.endsWith(".zip")){alert("ZIPファイルを選択してください");return}let r=await JSZip.loadAsync(i),o=Object.keys(r.files),d=o.find(e=>e.endsWith(".json"));if(!d)throw Error("model.json ファイルが見つかりません");let s=o.filter(e=>e!==d),c=await r.files[d].async("string"),p=await Promise.all(s.map(async e=>{let t=await r.files[e].async("arraybuffer");return new File([t],e,{type:"application/octet-stream"})})),u=new File([c],d,{type:"application/json"}),m=await tf.io.browserFiles([u,...p]);console.log(m),a=await tf.loadLayersModel(m),console.log(a);let y=await getModelNames();do tmpModelName=prompt("使われていないモデルの名前を入力してください（半角英数のみ）");while(y.includes(tmpModelName));await a.save(`indexeddb://${l=tmpModelName}`),await addOptions(),selectModelOnSetting(l)}catch(g){console.error("モデルの読み込みに失敗しました:",g),alert("モデルの読み込みに失敗しました")}t.value=""}),e.appendChild(t),e.appendChild(n)}function addInputModelDiv(){let e=document.createElement("div");e.id="_inputDiv";let t=document.createElement("input");t.id="inputTag",t.placeholder="新しいモデルのURLを入力";let n=document.createElement("button");n.innerHTML="追加",n.id="inputButton",n.onclick=function(){let e=document.getElementById("inputTag");console.log(e.value),getModelNames().then(t=>{do null==(userInput=prompt("名前を入力してください:"))&&(userInput=extractModelName(url));while(t.includes(userInput));loadModel(e.value,userInput),e.value=""})},e.appendChild(t),e.appendChild(n),document.getElementById("modelModals").appendChild(e)}async function addOptions(){let e=await getModelNames(),t=document.getElementById("modelModals");t.innerHTML="",addInputModelDiv(),addLoadingButton(),e.forEach(e=>{let n=document.createElement("div");n.className="modelModal",n.id=e,n.text=e;let a=document.createElement("h3");a.textContent=e,n.appendChild(a);let l=document.createElement("p");getModelsDate(e).then(e=>{l.textContent=e||"未取得"});let i=document.createElement("button");i.textContent="選択",i.id=n.id,i.onclick=function(){selectModelOnSetting(this.id)};let r=document.createElement("button");r.textContent="削除",r.id=n.id,r.onclick=function(){removeModelOnSetting(this.id)};let o=document.createElement("button");o.textContent="保存",o.id=n.id,o.onclick=function(){downloadModel(this.id)},n.appendChild(a),n.appendChild(l),n.appendChild(i),n.appendChild(o),n.appendChild(r),n.id==modelName&&(n.style.background="pink"),t.appendChild(n)})}function selectModelOnSetting(e){selectingModel=e;let t=document.querySelectorAll("#modelModals div");t.forEach(e=>{e.style.background="white"}),document.getElementById(e).style.background="pink"}function removeModelOnSetting(e){console.log(e),removeTarget.push(e),document.getElementById(e).remove()}async function downloadModel(e){try{console.log(e);let t=await tf.loadLayersModel(`indexeddb://${e}`);await t.save(tf.io.withSaveHandler(async t=>{let n=new JSZip,a=`${e}.weights.bin`,l={modelTopology:t.modelTopology,weightsManifest:[{paths:[a],weights:t.weightSpecs}]};n.file(`${e}.json`,JSON.stringify(l)),n.file(a,new Blob([t.weightData]));let i=await n.generateAsync({type:"blob"}),r=document.createElement("a");r.href=URL.createObjectURL(i),r.download=`${e}.zip`,document.body.appendChild(r),r.click(),document.body.removeChild(r),console.log(`モデル ${e} を 保存しました`)}))}catch(n){console.error(`モデル ${e} の保存に失敗しました`,n)}}function applyModalSetting(){removeTarget.forEach(e=>{tf.io.removeModel(`indexeddb://${e}`)}),console.log(`this:${selectingModel}`),selectingModel&&(removeTarget.includes(selectingModel)?loadModel("https://kurorosuke.github.io/AI_models/model3"):loadModel("notNull",selectingModel)),closeModelModal()}function closeModelModal(){removeTarget=[],document.getElementById("modelModals").style.display="none",document.getElementById("buttonModal").style.display="none",document.getElementById("overlay").style.display="none"}let markdownToggleCleanup=null,material4explain,dictSearchQuery="",dictSortOption="nameAsc";function populateDictionary(){let e=document.getElementById("moleculeGrid");e.innerHTML="",filterAndSortMaterials().forEach((t,n)=>{let a=document.createElement("div");a.style.border="1px solid #ccc",a.style.borderRadius="10px",a.style.padding="10px",a.style.textAlign="center",a.style.backgroundColor="#fff",a.style.boxShadow="2px 2px 5px rgba(0,0,0,0.1)";let l=document.createElement("h4");l.textContent=t.a,l.style.margin="5px 0";let i=document.createElement("p");i.textContent=t.b;let r=document.createElement("p");r.textContent=`ポイント: ${t.c}`,a.appendChild(l),a.appendChild(i),a.appendChild(r),a.addEventListener("click",()=>{openMoleculeDetail(t,n)}),e.appendChild(a)})}function filterAndSortMaterials(){let e=materials.filter(e=>{let t=dictSearchQuery.toLowerCase();return e.a.toLowerCase().includes(t)||e.b.toLowerCase().includes(t)}),t=e.sort((e,t)=>{switch(dictSortOption){case"nameAsc":return e.a.localeCompare(t.a,"ja");case"nameDesc":return t.a.localeCompare(e.a,"ja");case"pointAsc":return e.c-t.c;case"pointDesc":return t.c-e.c;default:return 0}});return t}document.getElementById("dictSearch").addEventListener("input",e=>{dictSearchQuery=e.target.value,populateDictionary()}),document.getElementById("dictSort").addEventListener("change",e=>{dictSortOption=e.target.value,populateDictionary()});let viewer3D=null;function normalizeFormula(e){let t={"₀":"0","₁":"1","₂":"2","₃":"3","₄":"4","₅":"5","₆":"6","₇":"7","₈":"8","₉":"9"},n={"⁰":"0","\xb9":"1","\xb2":"2","\xb3":"3","⁴":"4","⁵":"5","⁶":"6","⁷":"7","⁸":"8","⁹":"9","⁺":"+","⁻":"-"},a="";for(let l of e)t[l]?a+=t[l]:n[l]?a+=n[l]:a+=l;return a}function createOrGetViewer(){return viewer3D||(viewer3D=$3Dmol.createViewer("viewer3D",{backgroundColor:"white"}),window.addEventListener("resize",()=>viewer3D.resize())),viewer3D}function safeCreateViewer(){let e=document.getElementById("viewer3D");return 0===e.offsetWidth||0===e.offsetHeight?new Promise(e=>requestAnimationFrame(()=>e(safeCreateViewer()))):Promise.resolve($3Dmol.createViewer(e,{backgroundColor:"white"}))}async function view3DMaterial(e){let t=createOrGetViewer();t.removeAllModels(),t.removeAllShapes();let n=`https://kurorosuke.github.io/MolData/${await normalizeFormula(e)}.mol`,a=await (await fetch(n)).text();t.addModel(a,"sdf"),t.setStyle({},{stick:{},sphere:{scale:.3}}),t.zoomTo(),t.render()}function openMoleculeDetail(e){material4explain=e,sessionStorage.setItem("lastDictionary",e.b),detailName.textContent=e.a,detailFormula.textContent=`組成式: ${e.b}`,detailPoint.textContent=`ポイント: ${e.c}`,detailAdvantage.textContent=`有利な物質: ${e.e.join(", ")}`,moleculeDetailModal.style.display="block",requestAnimationFrame(()=>view3DMaterial(e.b)),detailDescription.value="",initMarkdownToggle(e)}function closeMoleculeDetail(){document.getElementById("moleculeDetailModal").style.display="none",sessionStorage.removeItem("lastDictionary")}const makeDescKey=e=>`description_${e}`;async function saveDescription(e,t){await setItem(makeDescKey(e),t)}async function loadDescription(e){return await getItem(makeDescKey(e))}function initMarkdownToggle(e){let t=document.getElementById("detailDescription"),n=document.getElementById("markdownPreview"),a=document.getElementById("editButton"),l=document.getElementById("saveButton");async function i(){n.innerHTML=marked.parse(t.value),window.MathJax&&MathJax.typesetPromise&&await MathJax.typesetPromise([n]),t.style.display="none",n.style.display="block",l.style.display="none",a.style.display="inline-block",await saveDescription(e.b,t.value)}l.addEventListener("click",i),a.addEventListener("click",function e(){t.style.display="block",n.style.display="none",l.style.display="inline-block",a.style.display="none"}),loadDescription(e.b).then(n=>{t.value=n??`[${e.a} の Wikipedia](https://ja.wikipedia.org/wiki/${e.a})<br>`,i()})}function fetchRankingRealtime(){let e=database.ref("players/");e.on("value",e=>{if(e.exists()){let t=e.val(),n=Object.entries(t).map(([e,t])=>({userId:e,name:t.Name,rate:t.Rate}));n.sort((e,t)=>t.rate-e.rate);let a=n.slice(0,10);showRanking(a)}else console.log("プレイヤーデータが存在しません")},e=>{console.error("データ取得エラー:",e)})}function showRanking(e){let t=document.querySelector("#rankingTable tbody");t.innerHTML="",e.forEach((e,n)=>{let a=document.createElement("tr");a.innerHTML=`
          <td>${n+1}</td>
          <td>${e.name}</td>
          <td>${e.rate}</td>
        `,t.appendChild(a)})}async function getAllNames(){let e=await database.ref("players").once("value"),t=await e.val();return t?Object.values(t).map(e=>e.Name):[]}async function changeName(){let e=document.getElementById("name-change"),t=e.value.trim();if(!t){console.log("❌ 空の名前は使えません"),document.getElementById("UserDataMessage").innerHTML="空の名前は使えません";return}let n=await getAllNames();if(console.log(n),n.includes(t)){console.log("❌ この名前は既に使われています"),document.getElementById("UserDataMessage").innerHTML="この名前は既に使われています";return}let a=firebase.auth().currentUser,l=database.ref("players/"+a.uid);l.update({Name:t}).then(()=>{console.log("✅ 名前を更新しました"),document.getElementById("UserDataMessage").innerHTML="名前を更新しました",document.getElementById("UserNameTag").innerHTML=`名前： ${t}`}).catch(e=>{console.log("❌ エラー："+e.message),document.getElementById("UserDataMessage").innerHTML="エラー"})}const quests=[{id:1,name:"水を合成せよ",type:"create",target:"H₂O",completed:!1,award:50},{id:2,name:"25ポイント以上の物質を合成せよ",type:"point",targetPoint:25,completed:!1,award:50},{id:3,name:"アセチレンを合成せよ",type:"create",target:"C₂H₂",completed:!1,award:50},{id:4,name:"オゾンを合成せよ",type:"create",target:"O₃",completed:!1,award:50},{id:5,name:"酸化ベリリウムを合成せよ",type:"create",target:"BeO",completed:!1,award:50},{id:6,name:"水素化リチウムを合成せよ",type:"create",target:"LiH",completed:!1,award:50},{id:7,name:"メチルを合成せよ",type:"create",target:"CH₃",completed:!1,award:50},{id:8,name:"アンモニアを合成せよ",type:"create",target:"NH₃",completed:!1,award:100},{id:9,name:"塩化ナトリウムを合成せよ",type:"create",target:"NaCl",completed:!1,award:50},{id:10,name:"シアン化水素を合成せよ",type:"create",target:"HCN",completed:!1,award:100},{id:11,name:"酢酸を合成せよ",type:"create",target:"CH₃COOH",completed:!1,award:150},{id:12,name:"亜リン酸を合成せよ",type:"create",target:"H₃PO₃",completed:!1,award:130},{id:13,name:"炭酸マグネシウムを合成せよ",type:"create",target:"MgCO₃",completed:!1,award:130},{id:14,name:"60ポイント以上の物質を合成せよ",type:"point",targetPoint:60,completed:!1,award:100},{id:15,name:"ヨウ化カリウムを合成せよ",type:"create",target:"KI",completed:!1,award:50},{id:16,name:"過酸化水素を合成せよ",type:"create",target:"H₂O₂",completed:!1,award:75},{id:17,name:"窒化アルミニウムを合成せよ",type:"create",target:"AlN",completed:!1,award:75},{id:18,name:"二酸化ケイ素を合成せよ",type:"create",target:"SiO₂",completed:!1,award:75},{id:19,name:"炭酸を合成せよ",type:"create",target:"H₂CO₃",completed:!1,award:120},{id:20,name:"フッ化カルシウムを合成せよ",type:"create",target:"CaF₂",completed:!1,award:140},{id:21,name:"硫酸を合成せよ",type:"create",target:"H₂SO₄",completed:!1,award:180},{id:22,name:"硝酸を合成せよ",type:"create",target:"HNO₃",completed:!1,award:160},{id:23,name:"リン酸を合成せよ",type:"create",target:"H₃PO₄",completed:!1,award:200},{id:24,name:"80ポイント以上の物質を合成せよ",type:"point",targetPoint:80,completed:!1,award:150},{id:25,name:"シュウ酸を合成せよ",type:"create",target:"O₃",completed:!1,award:250},{id:26,name:"1ラウンドで合計100ポイント以上を得よ",type:"total_point",targetPoint:100,completed:!1,award:200},{id:27,name:"メタンを合成せよ",type:"create",target:"CH₄",completed:!1,award:80},{id:28,name:"ホルムアルデヒドを合成せよ",type:"create",target:"CH₂O",completed:!1,award:80},{id:29,name:"メタノールを合成せよ",type:"create",target:"CH₃OH",completed:!1,award:80},{id:30,name:"エタノールを合成せよ",type:"create",target:"C₂H₅OH",completed:!1,award:170},{id:31,name:"二酸化三鉄（酸化鉄II）を合成せよ",type:"create",target:"Fe₂O₃",completed:!1,award:150},{id:32,name:"チオシアン酸アンモニウムを合成せよ",type:"create",target:"NH₄SCN",completed:!1,award:170},{id:33,name:"チオ硫酸ナトリウムを合成せよ",type:"create",target:"Na₂S₂O₃",completed:!1,award:200},{id:34,name:"リン酸二水素ナトリウムを合成せよ",type:"create",target:"NaH₂PO₄",completed:!1,award:180},{id:35,name:"1ラウンドで合計120ポイント以上を得よ",type:"total_point",targetPoint:120,completed:!1,award:250},{id:36,name:"ホウ酸を合成せよ",type:"create",target:"H₃BO₃",completed:!1,award:130},{id:37,name:"ヨウ素酸カリウムを合成せよ",type:"create",target:"KIO₄",completed:!1,award:130},{id:38,name:"リン酸水素ナトリウムを合成せよ",type:"create",target:"Na₂HPO₄",completed:!1,award:180},];let currentQuestIndex=0;function changeQuest(){let e=document.getElementById("questList");e.innerHTML="";let t=quests.filter(e=>e.completed).length,n=quests.length,a=Math.round(t/n*100),l=document.getElementById("questProgress");if(l.style.width=a+"%",l.textContent=a+"%",currentQuestIndex<quests.length){let i=quests[currentQuestIndex];document.getElementById("questTitle").textContent=`クエスト：${i.name}`,currentQuestName.textContent=`クエスト名: ${i.name}`,"create"===i.type?currentQuestTarget.textContent=`目標: ${i.target} を合成`:"point"===i.type?currentQuestTarget.textContent=`目標: ${i.targetPoint} ポイント獲得`:"total_point"===i.type&&(currentQuestTarget.textContent=`目標: 1ラウンドで${i.targetPoint} ポイント獲得`)}else document.getElementById("questTitle").textContent="全てのクエストをクリアしました！",currentQuestName.textContent="全てのクエストをクリアしました！",currentQuestTarget.textContent="";quests.forEach((t,n)=>{if(!t.completed){let a=document.createElement("div"),l=document.createElement("p");l.textContent=`${t.name}`,a.style.border="1px solid black",a.style.textAlign="left",a.style.padding="0 0 0 15px",a.appendChild(l),e.appendChild(a)}}),e.style.margin="0 0 20px 0"}async function loadQuestsStatus(){let e=await getItem("questsStatus");myXP=await getItem("myXP"),e&&e.length===quests.length&&(quests.forEach((t,n)=>{t.completed=e[n].completed}),console.log("クエストの達成状況を読み込みました。")),-1===(currentQuestIndex=quests.findIndex(e=>!e.completed))&&(currentQuestIndex=quests.length)}async function saveQuestsStatus(){await setItem("questsStatus",quests),console.log("クエストの達成状況を保存しました。")}async function checkQuest(e,t){if(currentQuestIndex>=quests.length){console.log("全てのクエストをクリア済みです。");return}let n=quests[currentQuestIndex];"create"===n.type?n.completed||e.b!==n.target||(console.log(`✅ クエスト達成！: ${n.name}`),n.completed=!0,launchConfetti(),currentQuestIndex++,changeQuest(),saveQuestsStatus()):"point"===n.type?!n.completed&&t>=n.targetPoint&&(console.log(`✅ クエスト達成！: ${n.name}`),n.completed=!0,launchConfetti(),currentQuestIndex++,changeQuest(),saveQuestsStatus()):"total_point"===n.type&&!n.completed&&p2_point>=n.targetPoint&&(console.log(`✅ クエスト達成！: ${n.name}`),n.completed=!0,launchConfetti(),currentQuestIndex++,changeQuest(),saveQuestsStatus()),await setItem("myXP",myXP+=n.award),await saveQuestsStatus(),changeQuest()}function toggleQuestModal(){let e=document.getElementById("inGameQuestContent");"block"===e.style.display?e.style.display="none":e.style.display="block"}function launchConfetti(){"function"==typeof confetti&&confetti({particleCount:160,spread:70,origin:{y:.6}})}
